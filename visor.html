<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: system-ui, sans-serif;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  #info {
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 10px 16px;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 500;
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
  }
</style>

</head>
<body>
  <div id="map"></div>
  <div id="info">Loading trajectory...</div>

<script>
  const { createClient } = supabase;

  // ‚úÖ Your Supabase credentials
  const SUPABASE_URL = 'https://xvezdemtphqwgjukjhan.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2ZXpkZW10cGhxd2dqdWtqaGFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI4OTQxMTYsImV4cCI6MjA3ODQ3MDExNn0.ayOgM2MIXJiW_q4AbAyQ4KzgiiNEF5o7sQLr2d_oX1E';
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

  // üß≠ Get token from URL
  const params = new URLSearchParams(window.location.search);
  const token = params.get('t');
  if (!token) alert('Missing share token (?t=...)');

  // üó∫Ô∏è Initialize map
  const map = L.map('map').setView([0, 0], 2);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
  }).addTo(map);

  const marker = L.marker([0, 0]).addTo(map);
  const polyline = L.polyline([], { color: 'blue', weight: 5, opacity: 0.8 }).addTo(map);
  const infoBox = document.getElementById('info');

  // üïì Helper to format times nicely
  function formatTime(ts) {
    if (!ts) return '';
    return new Date(ts).toLocaleString();
  }

  // üìç Load all existing points for this token
  async function loadHistory() {
    const { data, error } = await supabaseClient
      .from('public_locations')
      .select('lat, lon, updated_at')
      .eq('share_token', token)
      .order('updated_at', { ascending: true });

    if (error) {
      console.error('Error loading history:', error);
      infoBox.textContent = 'Error loading data.';
      return;
    }

    if (!data || data.length === 0) {
      infoBox.textContent = 'Waiting for location data...';
      return;
    }

    const coords = data.map((d) => [d.lat, d.lon]);
    polyline.setLatLngs(coords);

    const last = data[data.length - 1];
    marker.setLatLng([last.lat, last.lon]);

    if (coords.length > 1) {
      map.fitBounds(polyline.getBounds(), { padding: [40, 40] });
    } else {
      map.setView([last.lat, last.lon], 14);
    }

    infoBox.textContent = `üìç Last update: ${formatTime(last.updated_at)}`;
  }

  // üîÑ Subscribe to realtime updates
  function subscribeRealtime() {
    supabaseClient
      .channel('live-locations')
      .on(
        'postgres_changes',
        {
          event: '*',
          schema: 'public',
          table: 'public_locations',
          filter: `share_token=eq.${token}`,
        },
        (payload) => {
          const { lat, lon, updated_at } = payload.new;
          polyline.addLatLng([lat, lon]);
          marker.setLatLng([lat, lon]);
          map.panTo([lat, lon]);
          infoBox.textContent = `üìç Last update: ${formatTime(updated_at)}`;
        }
      )
      .subscribe();
  }

  loadHistory();
  subscribeRealtime();
</script>
  
</body>
</html>
