<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Tracker (Ruta Compartida)</title>

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    #timestamp {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-family: sans-serif;
      font-size: 14px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="timestamp">Loading...</div>

  <script>
    // -----------------------------
    // 1️⃣ CONFIGURAR FIREBASE
    // -----------------------------
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROJECT.firebaseapp.com",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_PROJECT.appspot.com",
      messagingSenderId: "TU_MESSAGING_ID",
      appId: "TU_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // -----------------------------
    // 2️⃣ LEER TOKEN DESDE URL
    // -----------------------------
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");

    if (!token) alert("No token provided in URL (?token=...)");

    // -----------------------------
    // 3️⃣ CONFIGURAR MAPA
    // -----------------------------
    const map = L.map("map").setView([0, 0], 3);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 18,
    }).addTo(map);

    let polyline = null;
    let marker = null;

    // -----------------------------
    // 4️⃣ FUNCION PARA CARGAR RUTA
    // -----------------------------
    async function loadRoute() {
      try {
        const querySnapshot = await db.collection("locations")
          .where("shareToken", "==", token)
          .orderBy("timestamp", "asc")
          .get();

        const points = [];
        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.lat && data.lng) {
            points.push([data.lat, data.lng, data.timestamp?.toDate()]);
          }
        });

        if (points.length === 0) {
          document.getElementById("timestamp").textContent = "No locations yet.";
          return;
        }

        // Lat/Lng array para polyline
        const latlngs = points.map(p => [p[0], p[1]]);
        const last = points[points.length - 1];

        // Borrar anteriores
        if (polyline) map.removeLayer(polyline);
        if (marker) map.removeLayer(marker);

        // Dibujar polyline
        polyline = L.polyline(latlngs, { color: 'blue', weight: 4 }).addTo(map);

        // Dibujar marcador del último punto
        marker = L.marker([last[0], last[1]]).addTo(map);

        // Auto-zoom
        map.fitBounds(polyline.getBounds(), { padding: [30, 30] });

        // Timestamp
        document.getElementById("timestamp").textContent =
          "Last update: " + last[2].toLocaleString();

      } catch (err) {
        console.error("Error loading Firestore:", err);
        document.getElementById("timestamp").textContent = "Error loading route.";
      }
    }

    // Cargar al iniciar
    loadRoute();

    // Actualizar cada 10 segundos
    setInterval(loadRoute, 10000);

  </script>
</body>
</html>
